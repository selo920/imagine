--///////////////////////////////////////////////////////////////////////////
--// MultiplayerCreateGame.bed
--///////////////////////////////////////////////////////////////////////////
--// Copyright (c) 2004 Bugbear Entertainment ltd. 
--// All Rights Reserved.
--// 
--// Created on 9.6.2004 19:12:09
--// 
--// Authors: Pasi Matilainen (pasi.matilainen@bugbear.fi)
--///////////////////////////////////////////////////////////////////////////

dofile("data/menu/backdrops3.bed")

function EnterCreateGameMenu(backmenu)
	menu_multiplayer_creategame.backmenu = backmenu
	menu_multiplayer_lobby.backmenu = backmenu
	EnterMenu("menu_multiplayer_creategame")
end


local Layout=
{
	ListLeft=0,
	ListTop=68,
	ListFont=fontmedium(),
	
	LabelLeft=287,
	LabelFontColor=GetPaletteColor(33),
	
	OptionLeft=303,
	OptionWidth=337,
	OptionFontColor=GetPaletteColor(34),
	OptionDisabledFontColor=GetPaletteColor(2),
	OptionArrowIndentTop=4,
	OptionArrowIndentLeftRight=5,
	
	RowHeight=20,
	RowPadding=0,
	NumRows=9,
	
	InfoBoxPos=POS(0,313),
	InfoBoxSize=SIZE(640,88),
	InfoTextPos=POS(320,14),
	InfoTextSize=SIZE(500,47),
	InfoTextFont=fontmedium(),
	InfoTextFontColor=GetPaletteColor(34)
}

local EventListener

local OnGameTypeChanged, OnNumPlayersChanged, OnReservedChanged, OnRatedChanged

local GameModeDerby = {
	MULTIPLAYER_GAMEMODE,
	{MULTIPLAYER_GAMEMODE_WRECKINGDERBY, MULTIPLAYER_GAMEMODE_SURVIVORDERBY, MULTIPLAYER_GAMEMODE_FRAGDERBY, MULTIPLAYER_GAMEMODE_TAG, MULTIPLAYER_MIXEDDERBIES},
	{ReplicatedSession.GAMETYPE_DERBY_WRECKING, ReplicatedSession.GAMETYPE_DERBY_LMS, ReplicatedSession.GAMETYPE_DERBY_FRAG, ReplicatedSession.GAMETYPE_HUNTER_PREY, ReplicatedSession.GAMETYPE_TOURNAMENT_DERBY},
	1,
	true,
	nil,
	{MULTIPLAYER_GAMEMODE_WRECKINGDERBY_DESCRIPTION, MULTIPLAYER_GAMEMODE_SURVIVORDERBY_DESCRIPTION, MULTIPLAYER_GAMEMODE_FRAGDERBY_DESCRIPTION, MULTIPLAYER_GAMEMODE_TAG_DESCRIPTION }
}

local OptionItems = {
	{
		MULTIPLAYER_SESSIONTYPE,
		{MULTIPLAYER_SESSIONTYPE_SINGLERACE, MULTIPLAYER_SESSIONTYPE_TOURNAMENT},
		{1, 2},
		1,
		true,
		nil,
		{MULTIPLAYER_SESSIONTYPE_SINGLERACE_DESCRIPTION, MULTIPLAYER_SESSIONTYPE_TOURNAMENT_DESCRIPTION}
	},	
	{
		MULTIPLAYER_RANKEDGAME,
		{UI_YES, UI_NO},
		{1, 0},
		2,
		true,
		function()OnRatedChanged()end,
		{MULTIPLAYER_RANKED_YES_DESCRIPTION, MULTIPLAYER_RANKED_NO_DESCRIPTION}
	},
	{
		MULTIPLAYER_GAMETYPE,
		{MULTIPLAYER_GAMETYPE_RACE, MULTIPLAYER_GAMETYPE_STUNT, MULTIPLAYER_GAMETYPE_DERBY },
		{1, 2, 3},
		1,
		false,
		function()OnGameTypeChanged()end,
		{MULTIPLAYER_GAMETYPE_RACE_DESCRIPTION, MULTIPLAYER_GAMETYPE_STUNT_DESCRIPTION, MULTIPLAYER_GAMETYPE_DERBY_DESCRIPTION }
	},
	{
		MULTIPLAYER_GAMEMODE,
		{L""},
		{0},
		1,
		false,
		nil,
	},
	{
		MULTIPLAYER_CARTYPE,
		{MULTIPLAYER_CARTYPE_ANY, MULTIPLAYER_CARTYPE_DERBY, MULTIPLAYER_CARTYPE_RACING, MULTIPLAYER_CARTYPE_STREET, MULTIPLAYER_CARTYPE_STUNT},
		{SessionInfo.CarClass.Any, SessionInfo.CarClass.ClassA, SessionInfo.CarClass.ClassB, SessionInfo.CarClass.ClassC, SessionInfo.CarClass.Stunt},
		1,
		true,
		nil,
		{MULTIPLAYER_CARTYPE_ANY_DESCRIPTION, MULTIPLAYER_CARTYPE_STREET_DESCRIPTION, MULTIPLAYER_CARTYPE_RACING_DESCRIPTION, MULTIPLAYER_CARTYPE_DERBY_DESCRIPTION, MULTIPLAYER_CARTYPE_STUNT_DESCRIPTION}
	},
	{
		MULTIPLAYER_UPGRADES,
		{L"0%", L"50%", L"100%", MULTIPLAYER_UPGRADES_CHOICE},
		{SessionInfo.CarUpgrades.None, SessionInfo.CarUpgrades.Half, SessionInfo.CarUpgrades.All, SessionInfo.CarUpgrades.Any},
		3,
		true,
		nil,
		{MULTIPLAYER_UPGRADES_0_DESCRIPTION, MULTIPLAYER_UPGRADES_50_DESCRIPTION, MULTIPLAYER_UPGRADES_100_DESCRIPTION, MULTIPLAYER_UPGRADES_ANY_DESCRIPTION}
	},
	{
		MULTIPLAYER_NITRO,
		{L"0x", L"0.5x", L"1x", L"2x"},
		{SessionInfo.NitroRegen.Regen0, SessionInfo.NitroRegen.Regen50, SessionInfo.NitroRegen.Regen100, SessionInfo.NitroRegen.Regen200},
		3,
		true,
		nil,
		{MULTIPLAYER_NITRO_0_DESCRIPTION, MULTIPLAYER_NITRO_50_DESCRIPTION, MULTIPLAYER_NITRO_100_DESCRIPTION, MULTIPLAYER_NITRO_200_DESCRIPTION}
	},
	{
		MULTIPLAYER_PLAYERS,
		{L"2", L"3", L"4", L"5", L"6", L"7", L"8"},
		{2, 3, 4, 5, 6, 7, 8},
		7,
		true,
		function()OnNumPlayersChanged()end,
		MULTIPLAYER_PLAYERS_DESCRIPTION
	},
	{
		MULTIPLAYER_RESERVED,
		{L"0", L"1", L"2", L"3", L"4", L"5", L"6", L"7"},
		{0, 1, 2, 3, 4, 5, 6, 7, 8, -1},
		1,
		true,
		function()OnReservedChanged()end,
		MULTIPLAYER_RESERVEDFORFRIENDS_DESCRIPTION
	},
	{
		MULTIPLAYER_LANGUAGE,
		{MULTIPLAYER_LANGUAGE_ANY, MULTIPLAYER_LANGUAGE_ENGLISH, MULTIPLAYER_LANGUAGE_GERMAN, MULTIPLAYER_LANGUAGE_FRENCH, MULTIPLAYER_LANGUAGE_SPANISH, MULTIPLAYER_LANGUAGE_ITALIAN},
		{1, 2, 3, 4, 5, 6},
		1,
		true,
		nil,
		{MULTIPLAYER_LANGUAGE_ANY_DESCRIPTION, MULTIPLAYER_LANGUAGE_ENGLISH_DESCRIPTION, MULTIPLAYER_LANGUAGE_GERMAN_DESCRIPTION, MULTIPLAYER_LANGUAGE_FRENCH_DESCRIPTION, MULTIPLAYER_LANGUAGE_SPANISH_DESCRIPTION, MULTIPLAYER_LANGUAGE_ITALIAN_DESCRIPTION}
	},
	{
		MULTIPLAYER_RACEDAMAGELEVEL,
		{L"0x", L"0.5x", L"1x", L"1.5x", L"2x"},
		{ReplicatedSession.DAMAGELEVEL_0, ReplicatedSession.DAMAGELEVEL_50, ReplicatedSession.DAMAGELEVEL_100, ReplicatedSession.DAMAGELEVEL_150, ReplicatedSession.DAMAGELEVEL_200},
		3,
		true,
		nil,
		{MULTIPLAYER_RACEDAMAGELEVEL_0_DESCRIPTION, MULTIPLAYER_RACEDAMAGELEVEL_50_DESCRIPTION, MULTIPLAYER_RACEDAMAGELEVEL_100_DESCRIPTION, MULTIPLAYER_RACEDAMAGELEVEL_150_DESCRIPTION, MULTIPLAYER_RACEDAMAGELEVEL_200_DESCRIPTION}
	},
	{
		MULTIPLAYER_DERBYDAMAGELEVEL,
		{L"0.5x", L"1x", L"1.5x", L"2x"},
		{ReplicatedSession.DERBYDAMAGELEVEL_50, ReplicatedSession.DERBYDAMAGELEVEL_100, ReplicatedSession.DERBYDAMAGELEVEL_150, ReplicatedSession.DERBYDAMAGELEVEL_200},
		2,
		true,
		nil,
		{MULTIPLAYER_DERBYDAMAGELEVEL_50_DESCRIPTION, MULTIPLAYER_DERBYDAMAGELEVEL_100_DESCRIPTION, MULTIPLAYER_DERBYDAMAGELEVEL_150_DESCRIPTION, MULTIPLAYER_DERBYDAMAGELEVEL_200_DESCRIPTION}
	}
}

local NumOptions=12

-- OptionItem item indexes
local Label=1
local ItemLabels=2
local ItemValues=3
local SelectedItem=4
local Enabled=5
local OnChanged=6
local Descriptions=7

-- OptionItem indexes
local SessionType=1
local RankedGame=2
local GameType=3
local GameMode=4
local CarType=5
local Upgrades=6
local NitroRegen=7
local Players=8
local Reserved=9
local Language=10
local DamageLevel=11
local DerbyDamageLevel=12

local SelectedTrack

local function GetEnabled(RowNr)
	return OptionItems[RowNr][Enabled]
end

local function SetEnabled(RowNr, Enable)
	OptionItems[RowNr][Enabled]=Enable
end

local function GetSelectedItem(RowNr)
	return OptionItems[RowNr][SelectedItem]
end

local function SetSelectedItem(RowNr, Item)
	OptionItems[RowNr][SelectedItem]=Item
end

local function GetSelectedItemValue(rowNr)
	return OptionItems[rowNr][ItemValues][OptionItems[rowNr][SelectedItem] ]
end

local function GetSelectedItemLabel(rowNr)
	return OptionItems[rowNr][ItemLabels][OptionItems[rowNr][SelectedItem] ]
end

local function GetNumItems(RowNr)
	return table.getn(OptionItems[RowNr][ItemValues])
end

local function CreateSession(tournamentEvents)
	Creating=true
	ShowThinkingWindow(SAFEPOS(240, 147))

	--Network:StartMultiplayer()

	local info
	if MultiplayerMode == MPMODE_LAN then
		Network:CreateLanSession()
		info = Session:GetInfo()
		info.SessionName = PlayerProfile:GetName()
	elseif MultiplayerMode == MPMODE_GAMESPY then
		GameSpy:StopUpdate()
		Network:CreateGameSpySession()
		GameSpy:ResumeUpdate()
		info = Session:GetInfo()
		info.SessionName = L(GameSpyPresence:GetAccountProfileName())
	elseif MultiplayerMode == MPMODE_XBOXLIVE then
		Network:CreateXBoxLiveSession()	
		info = Session:GetInfo()
		info.SessionName = XBoxLive.Auth.GetSignedInUserName(1)
	end
	
	if XBOX and GetSelectedItemValue(RankedGame) == 1 then
		local gametype = GetSelectedItemValue(GameType)
		local gamemode = GetSelectedItemValue(GameMode)
		if gametype == 1 then
			info.TournamentType = ReplicatedSession.GAMETYPE_RACE
		elseif gametype == 2 then
			info.TournamentType = ReplicatedSession.GAMETYPE_STUNT
		elseif gametype == 3 then
			info.TournamentType = gamemode
		else
			info.TournamentType = ReplicatedSession.GAMETYPE_TOURNAMENT
		end
	else
		info.TournamentType = ReplicatedSession.GAMETYPE_TOURNAMENT
	end
	
	for i = 1, table.getn(tournamentEvents) do
		Session:AddRace()
		info.Races[i].StageNr = tournamentEvents[i].trackid
		info.Races[i].TrackType = tournamentEvents[i].rules
		info.Races[i].EventType = tournamentEvents[i].rules
		info.Races[i].LapsOrTimeLimit = tournamentEvents[i].lapsOrTimeLimit
		if info.Races[i].EventType == ReplicatedSession.GAMETYPE_HUNTER_PREY then
			info.Races[i].NumHunters = tournamentEvents[i].numhunters
		end
		info.Races[i].Raced = false
	end
	
	tournamentEvents = { }
	
	info.NextRace		= 1
	info.MaxPublicSlots	= GetSelectedItemValue(Players) - GetSelectedItemValue(Reserved)
	info.MaxPrivateSlots= GetSelectedItemValue(Reserved)
	info.CarClass		= GetSelectedItemValue(CarType)
	info.CarUpgrades	= GetSelectedItemValue(Upgrades)
	info.NitroRegen		= GetSelectedItemValue(NitroRegen)
	info.RatedGame		= GetSelectedItemValue(RankedGame)
	info.Language		= GetSelectedItemValue(Language)
	info.DamageLevel	= GetSelectedItemValue(DamageLevel)
	info.DerbyDamageLevel	= GetSelectedItemValue(DerbyDamageLevel)

	Session:CreateSession()
end

local function NetworkEvents(event)
	if event.id == EVENT_NETWORK_REQUEST_PLAYERUPDATE then
		local player=Session:GetLocalPlayer(1)
		
		if MultiplayerMode == MPMODE_LAN then
			player:GenerateUserId()
			player.Name=PlayerProfile:GetName()
		elseif MultiplayerMode == MPMODE_GAMESPY then
			player.UId = GameSpyPresence.GetLoggedInProfileID()
			player.Name=L(GameSpyPresence.GetProfileUniqueNick())
		elseif MultiplayerMode == MPMODE_XBOXLIVE then
			player.Name=XBoxLive.Auth.GetSignedInUserName(1)
			player.UId=XBoxLive.Auth.GetSignedInUserId(1)
		end
		
		local info = Session:GetInfo()

		if info.CarClass > 4 then
			player.Car = info.CarClass - 5
		elseif info.CarClass == SessionInfo.CarClass.Stunt then
			player.Car = CarlistStuntCars()[1].index		
		elseif info.CarClass ~= SessionInfo.CarClass.Any then
			player.Car = CarlistFromClass(info.CarClass, false, true)[1].index
		else
			player.Car = 0
		end
		
		player.CarSkin = 1
		--player.Score = 0
		player.TournamentPoints = 0
		
		if info.CarUpgrades ~= SessionInfo.CarUpgrades.Any then
			player.UpgradeLevel = info.CarUpgrades
		else
			player.UpgradeLevel = SessionInfo.CarUpgrades.All
		end
		
		player.SessionChanged = false
	elseif event.id == EVENT_NETWORK_CREATE_SESSION_RESULT then
		Event:RemoveListener(EventListener)
		if event.data == 1 then
			HideThinkingWindow()
			ShowLobby()
		elseif event.data == 0 then
			HideThinkingWindow()
			Network:StopMultiplayer()
			
			MessageBox(
				LIVE_FAILED,
				MESSAGEBOX_YESNO,
				function(value)
					if value == TRUE then
						CreateSession()
					else
						menu_multiplayer_creategame.back()
					end
				end
			)
		end
	end
end

OnNumPlayersChanged = function()
	local numPlayers = GetSelectedItem(Players)
	if GetSelectedItemValue(Reserved) > GetSelectedItemValue(Players) - 1 then
		-- Players is 2-8, Reserved is 0-7, Reserved must be lower than Players
		SetSelectedItem(Reserved, GetSelectedItem(Players) + 1)
	end
end

OnReservedChanged = function()
	-- There be kludges here
	if GetSelectedItemValue(Reserved) == -1 then
		SetSelectedItem(Reserved, GetSelectedItem(Players) + 1)
	elseif GetSelectedItemValue(Reserved) > GetSelectedItemValue(Players) - 1 then
		SetSelectedItem(Reserved, 1)
	end
end

OnRatedChanged = function()
	if GetSelectedItemValue(RankedGame) == 0 then
		SetEnabled(GameType, false)
		SetSelectedItem(GameType, 4)
		SetEnabled(GameMode, false)
		SetEnabled(DamageLevel, true)
		SetEnabled(DerbyDamageLevel, true)
		SetEnabled(Reserved, true)
	else
		SetEnabled(GameType, true)
		SetSelectedItem(GameType, 1)
		SetEnabled(Reserved, false)
		OnGameTypeChanged()
	end
end

OnGameTypeChanged = function()
	local gameType = GetSelectedItemValue(GameType)
	if gameType == 1 then
		--OptionItems[GameMode] = GameModeRace
		SetEnabled(GameMode, false)
		SetEnabled(DamageLevel, true)
		SetEnabled(DerbyDamageLevel, false)
	elseif gameType == 3 then
		OptionItems[GameMode] = GameModeDerby
		SetEnabled(GameMode, true)
		SetEnabled(DamageLevel, false)
		SetEnabled(DerbyDamageLevel, true)
	else
		SetEnabled(GameMode, false)
		SetEnabled(DamageLevel, false)
		SetEnabled(DerbyDamageLevel, false)
	end
end

local function UpdateArrows(self)
	local leftarrow = wm.GetWindow("leftarrow")
	local rightarrow = wm.GetWindow("rightarrow")
	
	local row = wm.GetWindow("optionlist"):GetSelectedRow()
	local y = Layout.ListTop + Layout.RowHeight * (row - 1)
	
	local leftArrowSize = wm.GetResourceSize(self:getResource("scroll_left_icon"))
	local rightArrowSize = wm.GetResourceSize(self:getResource("scroll_right_icon"))

	local xpos = Layout.OptionLeft + 6 * (row - 1) + Layout.OptionArrowIndentLeftRight + 6
	leftarrow:SetPosition(xpos, y + 2)

	local value = wm.GetWindow("optionvalue_row"..row)
	local xpos,_ = wm.GetTextExtents(value:GetTitle(), Layout.ListFont)
	xpos = Layout.OptionLeft + xpos + leftArrowSize[1] + 2 * Layout.OptionArrowIndentLeftRight + 6 * (row - 1) + 9

	rightarrow:SetPosition(xpos, y + 2)
end

UpdateInfoText = function()
	local selectedRow = wm.GetWindow("optionlist"):GetSelectedRow()
	local descs = OptionItems[selectedRow][Descriptions]
	if descs ~= nil then
		local desc
		if type(descs) == "table" then
			desc = descs[GetSelectedItem(selectedRow)]
		else
			desc = descs
		end
		
		local infotext = wm.GetWindow("infotext")
		if desc then
			infotext:SetTitle(desc)
			infotext:WordWrap()
			local w,h = wm.GetTextExtents(infotext:GetTitle(), fontmedium())
			local w2,h2 = infotext:GetParent():GetSize()
			infotext:SetPosition(320, (h2-h)/2)
		else
			infotext:SetTitle(L"")
		end
	end
end

local function ChooseTrack()
	local tournamenttype
	
	if XBOX and GetSelectedItemValue(RankedGame) == 1 then
		local gametype = GetSelectedItemValue(GameType)
		local gamemode = GetSelectedItemValue(GameMode)
		if gametype == 1 then
			tournamenttype = ReplicatedSession.GAMETYPE_RACE
		elseif gametype == 2 then
			tournamenttype = ReplicatedSession.GAMETYPE_STUNT
		elseif gametype == 3 then
			tournamenttype = gamemode
		else
			tournamenttype = ReplicatedSession.GAMETYPE_TOURNAMENT
		end
	else
		tournamenttype = ReplicatedSession.GAMETYPE_TOURNAMENT
	end
	
	if GetSelectedItemValue(SessionType) == 1 then
		EnterMultiplayerRaceSelection(
			tournamenttype, 
			function(event)
				EventListener = Event:AddListener(NetworkEvents, EVENTTYPE_NETWORK)
				CreateSession( { event } )
			end,
			entermenu("menu_multiplayer_creategame"),
			GetSelectedItemValue(Players)
		)
	else
		EnterBuildTournamentMenu(
			tournamenttype,
			function(tournamentEvents)
				EventListener = Event:AddListener(NetworkEvents, EVENTTYPE_NETWORK)
				CreateSession(tournamentEvents)
			end,
			entermenu("menu_multiplayer_creategame"),
			false,
			GetSelectedItemValue(Players)
		)
	end
end

menu_multiplayer_creategame = CreateMenuFromTemplate("template_multiplayer")
menu_multiplayer_creategame.options.title = TITLE_LIVE_CREATEMATCH
menu_multiplayer_creategame.back = function() EnterMenu(menu_multiplayer_creategame.backmenu) end

function menu_multiplayer_creategame.create(self)
	self.parent:create(self)
	
	self:addResource("backdrops3.tga", backdrops3, backdrops3_size)
	self:loadResources()
	
	self.items = { }
end

function menu_multiplayer_creategame.init(self)
	self.parent:init(self)
	
	GUI:SetBackground("data/menu/menu_background.tga")
	
	if not XBOX and table.getn(OptionItems) == 12 then
		CarType=2
		Upgrades=3
		NitroRegen=4
		Players=5
		Reserved=6
		Language=7
		DamageLevel=8
		DerbyDamageLevel=9
		
		table.remove(OptionItems, GameMode)
		table.remove(OptionItems, GameType)
		table.remove(OptionItems, RankedGame)

		if PS2 then
			for i = 0, 1 do
				table.remove(OptionItems[Players][ItemValues], 8-i)
				table.remove(OptionItems[Reserved][ItemValues], 9-i)
			end
			SetSelectedItem(Players, 5)
		end
		
		NumOptions = table.getn(OptionItems)
	end
	
	EventListener=Event:AddListener(NetworkEvents, EVENTTYPE_NETWORK)

	Creating=false
	for i = 0, Garage:GetNumCars() - 1 do
		local car = db.FlatOut2.Cars:GetProperty("Car", i)
		table.insert(OptionItems[CarType][ItemLabels], L(car.Name))
		table.insert(OptionItems[CarType][ItemValues], 5 + i)
	end
	
	local lang,rang,str,lang2,rang2,str2
	if NumOptions == 12 then
		Layout.ListTop = 68
		Layout.InfoBoxPos = POS(0,313)
		lang = self:getResource("options_6_slices_l_ang")
		rang = self:getResource("options_6_slices_r_ang")
		str = self:getResource("options_6_strech")
		lang2 = self:getResource("options_6_slices_l_ang")
		rang2 = self:getResource("options_6_slices_r_ang")
		str2 = self:getResource("options_6_strech")
	else
		Layout.ListTop = 76 + (11 - NumOptions) * Layout.RowHeight / 2
		Layout.InfoBoxPos = POS(0,301)
		local num = NumOptions - 5
		lang = self:getResource("options_5_slices_l_ang")
		rang = self:getResource("options_5_slices_r_ang")
		str = self:getResource("options_5_strech")
		lang2 = self:getResource("options_"..num.."_slices_l_ang")
		rang2 = self:getResource("options_"..num.."_slices_r_ang")
		str2 = self:getResource("options_"..num.."_strech")
	end
			
	local angsize = wm.GetResourceSize(lang)
	local h = angsize[2]
	Frame { Position=POS(292,Layout.ListTop), Size=angsize, Layer=3 }:AttachResource(lang)
	angsize = wm.GetResourceSize(rang)
	Frame { Position=POS(302,Layout.ListTop), Size=angsize, Layer=3 }:AttachResource(rang)
	
	Frame { Position=POS(0,Layout.ListTop), Size=SIZE(292,h), Layer=3 }:AttachResource(str)
	Frame { Position=POS(342,Layout.ListTop), Size=SIZE(327,h), Layer=3 }:AttachResource(str)

	angsize = wm.GetResourceSize(lang2)
	Frame { Position=POS(327,Layout.ListTop+h+2), Size=angsize, Layer=3 }:AttachResource(lang2)
	angsize = wm.GetResourceSize(rang2)
	Frame { Position=POS(337,Layout.ListTop+h+2), Size=angsize, Layer=3 }:AttachResource(rang2)
	
	Frame { Position=POS(0,Layout.ListTop+h+2), Size=SIZE(327,angsize[2]), Layer=3 }:AttachResource(str2)
	Frame { Position=POS(378,Layout.ListTop+h+2), Size=SIZE(262,angsize[2]), Layer=3 }:AttachResource(str2)

	local listboxParams = {
		ListBoxTemplate	= { Name="optionlist" },
		Left			= Layout.ListLeft,
		Top				= Layout.ListTop,
		LeftPadding		= 0,
		RightPadding	= 0,
		TopPadding		= 0,
		BottomPadding	= 0,
		RowWidth		= 640,
		RowHeight		= Layout.RowHeight,
		RowPadding		= Layout.RowPadding,
		RowTemplate		= { DrawBackgroundColor=FALSE, TitleCentering=TITLE_CENTER_Y },
		RowTemplateType	= "Button",
		RowTemplateCust	= function(Row, RowNr)
		end,
		NumRows	= NumOptions,
		Coloumns = {
			[1] = {
				Name				= "optiontitle", -- _row# is added
				ColoumnTemplate		= { Font=Layout.ListFont, Color=Layout.LabelFontColor, Position=POS(Layout.LabelLeft, -2), Size=SIZE(Layout.OptionWidth, Layout.RowHeight), Align=FONTF_RIGHT, Layer=4 },
				ColoumnTemplateType	= "StaticText",
				ColoumnTemplateCust	= function(Coloumn, RowNr, ColoumnNr)
				end
			},
			[2] = {
				Name				= "optionvalue", -- _row# is added
				ColoumnTemplate		= { Font=Layout.ListFont, Color=Layout.OptionFontColor, Position=POS(Layout.OptionLeft, -2), Size=SIZE(Layout.OptionWidth, Layout.RowHeight), Layer=4 },
				ColoumnTemplateType	= "StaticText",
				ColoumnTemplateCust	= function(Coloumn, RowNr, ColoumnNr)
				end
			},
		}
	}
	
	local optionlist = CreateMultiColoumnListBox(listboxParams)
	optionlist:SetNumRows(NumOptions)
	optionlist:SetSelectedRow(1)
	optionlist.onNeedData = function(Self, RowObject, RowNr, ControlRowNr)
		local title = wm.GetWindow("optiontitle_row"..RowNr)
		local value = wm.GetWindow("optionvalue_row"..RowNr)
		
		local arrowSize = GetResourceSize(self:getResource("scroll_left_glow"))
		title:SetPosition(Layout.LabelLeft + 6 * (RowNr - 1), 0)
		value:SetPosition(Layout.OptionLeft + 6 * (RowNr - 1) + Layout.OptionArrowIndentLeftRight + arrowSize[1], 0)
		
		title:SetTitle(OptionItems[RowNr][Label])
		if OptionItems[RowNr][Enabled] then
			value:SetLayer(4)
			title:SetLayer(4)
			value:SetTitle(GetSelectedItemLabel(RowNr))
		else
			value:SetLayer(2)
			title:SetLayer(2)
			if XBOX and RowNr == GameType then
				value:SetTitle(MULTIPLAYER_GAMETYPE_MIXED)
			else
				value:SetTitle(L"")
			end
		end

		UpdateArrows(self)
	end

	--local arrowSize = GetResourceSize(self:getResource("scroll_left_glow"))
	--Frame { Name="leftarrow_glow", Position=POS(0,0), Size=arrowSize, Layer=4 }:AttachResource(self:getResource("scroll_left_glow"))
	local arrowSize = GetResourceSize(self:getResource("selection_arrow_r"))
	Frame { Name="leftarrow", Position=POS(0,0), Size=arrowSize, Layer=4 }:AttachResource(self:getResource("selection_arrow_r"))
	
--	arrowSize = GetResourceSize(self:getResource("scroll_right_glow"))
--	Frame { Name="rightarrow_glow", Position=POS(0,0), Size=arrowSize, Layer=4 }:AttachResource(self:getResource("scroll_right_glow"))
	arrowSize = GetResourceSize(self:getResource("selection_arrow_l"))
	Frame { Name="rightarrow", Position=POS(0,0), Size=arrowSize, Layer=4 }:AttachResource(self:getResource("selection_arrow_l"))
	
	local infobox = Frame { Position=Layout.InfoBoxPos, Size=Layout.InfoBoxSize }
	infobox:AttachResource(self:getResource("options_description_bd"))
	StaticText { Name="infotext", Position=Layout.InfoTextPos, Size=Layout.InfoTextSize, Font=Layout.InfoTextFont, Color=Layout.InfoTextFontColor, Parent=infobox, Align=FONTF_CENTER }
		
	local handler = InputHandler { Name="inputhandler" }
	handler.onKeyPressed = function(Self, Character, VirtualKey, ScanCode)
		local labels
				
		local selectedRow = optionlist:GetSelectedRow()
		if VirtualKey == KeyCodes["BUTTON_START"] then
			ChooseTrack()
			playmenusound_action()			
		elseif VirtualKey == KeyCodes["BUTTON_SELECT"] then
			menu_multiplayer_creategame.back()
			playmenusound_back()
		elseif VirtualKey == KeyCodes["BUTTON_LEFT"] then
			if GetEnabled(selectedRow) then
				local selectedItem = GetSelectedItem(selectedRow) - 1
				local numItems = GetNumItems(selectedRow)
				if selectedItem < 1 then
					selectedItem = numItems
				end
				SetSelectedItem(selectedRow,selectedItem)

				local onChanged = OptionItems[selectedRow][OnChanged]
				if onChanged ~= nil then
					onChanged(selectedRow)
				end
				
				optionlist:Refresh()
				UpdateInfoText()
				playmenusound_move()
			end
		elseif VirtualKey == KeyCodes["BUTTON_RIGHT"] then
			if GetEnabled(selectedRow) then
				local selectedItem = GetSelectedItem(selectedRow) + 1
				local numItems = GetNumItems(selectedRow)
				if selectedItem > numItems then
					selectedItem = 1
				end
				SetSelectedItem(selectedRow,selectedItem)

				local onChanged = OptionItems[selectedRow][OnChanged]
				if onChanged ~= nil then
					onChanged(selectedRow)
				end
				
				optionlist:Refresh()
				UpdateInfoText()
				playmenusound_move()
			end
		elseif VirtualKey == KeyCodes["BUTTON_DOWN"] then
			-- Skip any disabled rows
			local prevsel = optionlist:GetSelectedRow()
			repeat
				optionlist:MoveNext()
			until OptionItems[optionlist:GetSelectedRow()][Enabled] == true or optionlist:GetSelectedRow() == table.getn(OptionItems)
			if optionlist:GetSelectedRow() == table.getn(OptionItems) and OptionItems[optionlist:GetSelectedRow()][Enabled] == false then
				optionlist:SetSelectedRow(prevsel)
			end
			
			UpdateArrows(self)
			UpdateInfoText()
			playmenusound_move()
		elseif VirtualKey == KeyCodes["BUTTON_UP"] then
			-- Skip any disabled rows
			local prevsel = optionlist:GetSelectedRow()
			repeat
				optionlist:MovePrev()
			until OptionItems[optionlist:GetSelectedRow()][Enabled] == true or optionlist:GetSelectedRow() == 1
			if optionlist:GetSelectedRow() == 1 and OptionItems[optionlist:GetSelectedRow()][Enabled] == false then
				optionlist:SetSelectedRow(prevsel)
			end
			
			UpdateArrows(self)
			UpdateInfoText()
			playmenusound_move()
		end
	end

	if XBOX then	
--[[		if MultiplayerMode == MPMODE_LAN then
			OptionItems[RankedGame][Enabled] = false
			SetSelectedItem(RankedGame, 2)
			OnRatedChanged()
			optionlist:SetSelectedRow(4)
		else--]]
			OptionItems[RankedGame][Enabled] = true
			SetSelectedItem(RankedGame, 2)
			OnRatedChanged()
		--end
	end
	
	GUI:SetHelpButtons(BUTTON_OK, UI_CREATEGAME, BUTTON_BACK, UI_BACK)
	
	optionlist:Refresh()
	UpdateInfoText()
	
	handler:SetFocus()
end

function menu_multiplayer_creategame.update(self, time)
	self.parent:update(self, time)
end
	
function menu_multiplayer_creategame.deinit(self)
	self.parent:deinit(self)
	Event:RemoveListener(EventListener)
end
